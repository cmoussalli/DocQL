@using DocQL.Models
@using DocQL.Services
@inject BackupRestoreService BackupService

<Modal IsVisible="IsVisible" Title="Back Up Database" OnClose="Close" Size="Modal.ModalSize.Large">
    <ChildContent>
        <div class="form-group form-group-horizontal">
            <label class="form-label">Database:</label>
            <select class="form-select" @bind="Options.DatabaseName">
                @foreach (var db in Databases)
                {
                    <option value="@db">@db</option>
                }
            </select>
        </div>

        <div class="form-group form-group-horizontal">
            <label class="form-label">Backup type:</label>
            <select class="form-select" @bind="Options.Type">
                <option value="@BackupType.Full">Full</option>
                <option value="@BackupType.Differential">Differential</option>
                <option value="@BackupType.TransactionLog">Transaction Log</option>
            </select>
        </div>

        <div class="form-group form-group-horizontal">
            <label class="form-label">Backup to:</label>
            <input class="form-input" @bind="Options.FilePath"
                   placeholder="C:\Backups\database.bak" />
        </div>

        <div class="form-group form-group-horizontal">
            <label class="form-label">Name:</label>
            <input class="form-input" @bind="Options.BackupName"
                   placeholder="Optional backup name" />
        </div>

        <div class="form-group form-group-horizontal">
            <label class="form-label">Description:</label>
            <textarea class="form-textarea" @bind="Options.Description" rows="2"></textarea>
        </div>

        <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 6px;">
            <label class="form-checkbox">
                <input type="checkbox" @bind="Options.CompressBackup" />
                Compress backup
            </label>
            <label class="form-checkbox">
                <input type="checkbox" @bind="Options.CopyOnly" />
                Copy-only backup
            </label>
            <label class="form-checkbox">
                <input type="checkbox" @bind="Options.Checksum" />
                Verify backup with checksum
            </label>
        </div>

        @if (IsRunning)
        {
            <div style="margin-top: 12px; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <div class="spinner" style="width: 14px; height: 14px; border: 2px solid var(--border-secondary); border-top-color: var(--text-accent); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    <span style="font-size: var(--font-size-sm);">Backing up...</span>
                </div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary); max-height: 100px; overflow: auto;">
                    @ProgressMessage
                </div>
            </div>
        }

        @if (ResultMessage != null)
        {
            <div style="margin-top: 12px; padding: 8px; border-radius: 4px; font-size: var(--font-size-sm);
                        background: @(HasError ? "rgba(190,17,0,0.1)" : "rgba(45,139,45,0.1)");
                        color: @(HasError ? "var(--text-error)" : "var(--text-success)");">
                @ResultMessage
            </div>
        }
    </ChildContent>
    <Footer>
        <button class="btn" @onclick="GenerateScript">Script</button>
        <button class="btn btn-primary" @onclick="RunBackup" disabled="@IsRunning">OK</button>
        <button class="btn" @onclick="Close">Cancel</button>
    </Footer>
</Modal>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<string> OnScriptGenerated { get; set; }
    [Parameter] public List<string> Databases { get; set; } = new();

    private BackupOptions Options = new() { CompressBackup = true };
    private bool IsRunning;
    private string? ProgressMessage;
    private string? ResultMessage;
    private bool HasError;

    private async Task RunBackup()
    {
        IsRunning = true;
        ResultMessage = null;
        ProgressMessage = "";
        StateHasChanged();

        var result = await BackupService.BackupDatabaseAsync(Options, msg =>
        {
            ProgressMessage = msg;
            InvokeAsync(StateHasChanged);
        });

        IsRunning = false;
        HasError = result.HasErrors;
        ResultMessage = result.Messages.LastOrDefault()?.Text;
        StateHasChanged();
    }

    private async Task GenerateScript()
    {
        var script = BackupService.GenerateBackupScript(Options);
        await OnScriptGenerated.InvokeAsync(script);
        await Close();
    }

    private async Task Close()
    {
        ResultMessage = null;
        await OnClose.InvokeAsync();
    }
}
