@using DocQL.Models
@using DocQL.Services
@inject ImportExportService ImportExportService

<Modal IsVisible="IsVisible" Title="Import Data" OnClose="Close" Size="Modal.ModalSize.Large">
    <ChildContent>
        <div class="wizard">
            <div class="wizard-steps">
                <div class="wizard-step @(Step == 1 ? "active" : Step > 1 ? "completed" : "")">
                    <span class="wizard-step-number">1</span>
                    <span>Source</span>
                </div>
                <span class="wizard-step-arrow">&#9654;</span>
                <div class="wizard-step @(Step == 2 ? "active" : Step > 2 ? "completed" : "")">
                    <span class="wizard-step-number">2</span>
                    <span>Options</span>
                </div>
                <span class="wizard-step-arrow">&#9654;</span>
                <div class="wizard-step @(Step == 3 ? "active" : "")">
                    <span class="wizard-step-number">3</span>
                    <span>Result</span>
                </div>
            </div>

            <div class="wizard-content">
                @if (Step == 1)
                {
                    <div class="form-group form-group-horizontal">
                        <label class="form-label">Target Database:</label>
                        <select class="form-select" @bind="Database">
                            @foreach (var db in Databases)
                            {
                                <option value="@db">@db</option>
                            }
                        </select>
                    </div>
                    <div class="form-group form-group-horizontal">
                        <label class="form-label">Schema:</label>
                        <input class="form-input" @bind="Schema" style="width: 100px;" />
                    </div>
                    <div class="form-group form-group-horizontal">
                        <label class="form-label">Table:</label>
                        <input class="form-input" @bind="TableName" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">CSV Data:</label>
                        <textarea class="form-textarea" @bind="CsvContent" rows="12"
                                  placeholder="Paste CSV data here...&#10;Column1,Column2,Column3&#10;value1,value2,value3"></textarea>
                    </div>
                }
                else if (Step == 2)
                {
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" @bind="HasHeaders" />
                            First row contains column headers
                        </label>
                    </div>
                    <div class="form-group form-group-horizontal">
                        <label class="form-label">Delimiter:</label>
                        <select class="form-select" style="width: 120px;" @bind="Delimiter">
                            <option value=",">Comma (,)</option>
                            <option value="&#9;">Tab</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="|">Pipe (|)</option>
                        </select>
                    </div>
                    <div style="margin-top: 12px; font-size: var(--font-size-sm); color: var(--text-secondary);">
                        Preview: @(CsvContent?.Split('\n').Length ?? 0) lines detected
                    </div>
                }
                else if (Step == 3)
                {
                    @if (IsImporting)
                    {
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--border-secondary); border-top-color: var(--text-accent); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                            <span>Importing...</span>
                        </div>
                    }
                    else if (ImportResult != null)
                    {
                        <div style="margin-bottom: 8px; color: var(--text-success); font-weight: 600;">
                            @ImportResult.Value.RowsImported rows imported successfully.
                        </div>
                        @if (ImportResult.Value.Errors.Count > 0)
                        {
                            <div style="color: var(--text-error); font-size: var(--font-size-sm);">
                                <div style="font-weight: 600; margin-bottom: 4px;">Errors (@ImportResult.Value.Errors.Count):</div>
                                @foreach (var err in ImportResult.Value.Errors.Take(20))
                                {
                                    <div>@err</div>
                                }
                            </div>
                        }
                    }
                }
            </div>
        </div>
    </ChildContent>
    <Footer>
        @if (Step > 1)
        {
            <button class="btn" @onclick="() => Step--">Back</button>
        }
        @if (Step < 3)
        {
            <button class="btn btn-primary" @onclick="NextStep">Next</button>
        }
        @if (Step == 3 && ImportResult == null)
        {
            <button class="btn btn-primary" @onclick="RunImport" disabled="@IsImporting">Import</button>
        }
        <button class="btn" @onclick="Close">@(Step == 3 && ImportResult != null ? "Done" : "Cancel")</button>
    </Footer>
</Modal>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public List<string> Databases { get; set; } = new();

    private int Step = 1;
    private string Database = "master";
    private string Schema = "dbo";
    private string TableName = string.Empty;
    private string CsvContent = string.Empty;
    private bool HasHeaders = true;
    private string Delimiter = ",";
    private bool IsImporting;
    private (int RowsImported, List<string> Errors)? ImportResult;

    private void NextStep()
    {
        if (Step < 3) Step++;
    }

    private async Task RunImport()
    {
        IsImporting = true;
        StateHasChanged();

        var result = await ImportExportService.ImportCsvAsync(Database, Schema, TableName, CsvContent, HasHeaders, Delimiter);
        ImportResult = result;
        IsImporting = false;
    }

    private async Task Close()
    {
        Step = 1;
        ImportResult = null;
        await OnClose.InvokeAsync();
    }
}
